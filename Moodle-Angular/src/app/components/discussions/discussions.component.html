<div class="container py-4">
  <h1 class="mb-4">Forum de discussion</h1>

  <!-- Nouveau message -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Créer un nouveau message</h5>
      <form [formGroup]="forumForm" (ngSubmit)="onSubmit()">
        <div class="mb-3">
          <label for="message" class="form-label">Message</label>
          <textarea
            class="form-control"
            id="message"
            rows="4"
            formControlName="message"
            placeholder="Questions, annonce, message, sujet de discussion..."
          >
          </textarea>
          <div
            *ngIf="
              forumForm.get('message')?.invalid &&
              forumForm.get('message')?.touched
            "
            class="text-danger small"
          >
            Le message est requis (min. 3 caractères).
          </div>
        </div>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="forumForm.invalid"
        >
          Envoyer
        </button>
      </form>
    </div>
  </div>

  <div *ngFor="let forum of forums; let i = index">
    <div
      class="card mb-3 forum-card"
      (click)="toggleReponses(i)"
      [class.reponses-ouvertes]="afficherReponses[i]"
    >
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ getUserPrenom(forum.id_user) | uppercase }}</strong> •
          {{ forum.datetime_publier | date : "short" }}
        </div>
        <!-- bouton delete -->
        <button
          type="button"
          class="btn btn-sm btn-danger"
          title="Supprimer"
          (click)="deleteForum(forum._id, $event)"
          *ngIf="userRole === 'Enseignant'"
        >
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="card-body">
        <p>{{ forum.sujet }}</p>

        <p class="text-muted mb-2">
          <i class="bi bi-chat-left-text"></i>
          {{ forum.reponses?.length || 0 }} réponse{{
            forum.reponses?.length === 1 ? "" : "s"
          }}
        </p>

        <!-- Bouton Répondre -->
        <button
          class="btn btn-sm btn-outline-secondary"
          (click)="toggleFormulaire(i, $event)"
        >
          Répondre
        </button>

        <!-- Bloc réponses visibles -->
        <div
          [ngClass]="{ 'reponse-transition': true, show: afficherReponses[i] }"
          class="mt-3"
          (click)="$event.stopPropagation()"
        >
          <div
            class="card card-body bg-light position-relative"
            *ngFor="let rep of forum.reponses"
          >
            <button
              type="button"
              class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-2"
              title="Supprimer la réponse"
              (click)="deleteReply(forum._id, rep._id, i, $event)"
              *ngIf="userRole === 'Enseignant' || rep.id_user === userId"
            >
              <i class="bi bi-x-lg"></i>
            </button>

            <div class="pe-4">
              {{ rep.message }}
              <small class="text-muted d-block mt-2">
                {{ getUserPrenom(rep.id_user) }} •
                {{ rep.datetime_publier | date : "short" }}
              </small>
            </div>
          </div>
        </div>


        <!-- Formulaire réponse -->
        <div
          class="card card-body mt-2"
          *ngIf="afficherFormulaires[i]"
          (click)="$event.stopPropagation()"
        >
          <form
            [formGroup]="replyForms[i]"
            (ngSubmit)="onReplySubmit(forum._id, i)"
          >
            <div class="mb-2">
              <label for="message-rep" class="form-label">Réponse</label>
              <textarea
                #replyTextarea
                class="form-control"
                id="message-rep-{{ i }}"
                rows="2"
                formControlName="reply"
                placeholder="Votre réponse..."
              >
              </textarea>
              <div
                *ngIf="
                  replyForms[i].get('reply')?.invalid &&
                  replyForms[i].get('reply')?.touched
                "
                class="text-danger small"
              >
                La réponse ne peut pas être vide.
              </div>
            </div>
            <button
              type="submit"
              class="btn btn-sm btn-primary"
              [disabled]="replyForms[i].invalid"
            >
              Envoyer
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
